# Task T-4.1.1: Unit Tests for Core Infrastructure

## Meta
| Field | Value |
|-------|-------|
| Task ID | T-4.1.1 |
| Milestone | M4 - Testing & Polish |
| Module | Core Infrastructure |
| Priority | High |
| Effort | 6h |
| Estimated Tokens | 35K |
| Recommended Model | Sonnet |
| Dependencies | T-1.5.2 (module registry) |
| Parallel Group | PG-6 |
| AC Mapping | AC-009, AC-010, AC-011, AC-012, AC-013, AC-014, AC-015, AC-016, AC-018, AC-019, AC-020 |

## Objective

Create comprehensive unit tests for all core infrastructure components implemented in Milestone 1. This includes the configuration system, authentication strategies, HTTP client, and resilience layer (rate limiter, retry handler, circuit breaker). Target 85% code coverage on core infrastructure modules. These tests validate the foundational components that all domain modules depend on.

## Acceptance Criteria

- **Config system tests**:
  - **AC-015**: Verify three-tier precedence -- environment variable overrides config file value (e.g., `SERVICENOW_INSTANCE=mydev` wins over `servicenow.instance=myprod` in config file).
  - **AC-016**: Verify fail-fast behavior -- server fails with descriptive Zod validation error listing all missing required fields when configuration is incomplete.
  - Test default values are applied when neither env var nor config file provides a value.
  - Test partial config merging (some values from env, some from file, some defaults).

- **Auth strategy tests**:
  - **AC-009**: Given invalid credentials, when any tool is called, then the server returns an MCP error result with `isError: true` and error code `AUTHENTICATION_ERROR` -- the server does not crash.
  - **AC-014**: Given OAuth configuration, verify token is obtained, cached, and refreshed before expiry without manual intervention.
  - Test Basic Auth header construction (`Authorization: Basic base64(username:password)`).
  - Test OAuth token caching -- second call uses cached token, no second HTTP request.
  - Test OAuth token refresh -- expired token triggers re-fetch.
  - Test Token/Bearer strategy constructs correct `Authorization: Bearer {token}` header.

- **HTTP client tests**:
  - Test URL construction from instance name (e.g., `mydev` -> `https://mydev.service-now.com/api/now/table/{table}`).
  - Test query parameter serialization (`sysparm_query`, `sysparm_limit`, `sysparm_offset`, `sysparm_fields`, `sysparm_display_value`, `sysparm_order_by`).
  - Test request body serialization for POST/PATCH operations.
  - Test response parsing (extract `result` from ServiceNow JSON response).

- **Resilience tests**:
  - **AC-018**: Given rate limiter configured for 100 req/hour, verify subsequent requests are delayed after quota is exhausted -- no requests are dropped.
  - **AC-013**: Given ServiceNow returns HTTP 429, verify retry mechanism retries up to `max_retries` times with exponential backoff before returning error.
  - Test retry backoff timing follows exponential pattern with jitter.
  - Test retryable error detection (429, 503, network errors are retried; 400, 404 are not).
  - Test circuit breaker state transitions: CLOSED -> OPEN after failure threshold, OPEN -> HALF_OPEN after reset timeout, HALF_OPEN -> CLOSED on success, HALF_OPEN -> OPEN on failure.
  - **AC-020**: Given network timeout, verify server returns MCP error with `NETWORK_ERROR` code and does not hang.

- Overall coverage target: >=85% line coverage on `src/core/` and `src/config/` directories.

## Technical Notes

- **Test framework**: vitest (already configured in project scaffolding T-1.1.1).
- **Test file location**: `tests/unit/core/` directory, mirroring the `src/core/` structure.
- **Mocking strategy**:
  - Mock `fetch` / HTTP calls using vitest's `vi.fn()` or a library like `msw` (Mock Service Worker) for HTTP-level mocking.
  - Mock environment variables using `vi.stubEnv()` or process.env manipulation with cleanup.
  - Mock timers (`vi.useFakeTimers()`) for testing retry delays, token expiry, and circuit breaker timeouts.
- **Test organization**: Group tests by component with `describe` blocks:
  - `config.test.ts` -- configuration loading, validation, precedence
  - `auth-basic.test.ts` -- Basic auth strategy
  - `auth-oauth.test.ts` -- OAuth strategy (token lifecycle)
  - `auth-token.test.ts` -- Bearer token strategy
  - `http-client.test.ts` -- URL construction, query params, request/response
  - `rate-limiter.test.ts` -- token bucket behavior
  - `retry-handler.test.ts` -- retry logic, backoff, retryable detection
  - `circuit-breaker.test.ts` -- state machine transitions
- **Edge cases to cover**:
  - Config with all values from env vars (no config file).
  - Config with missing required fields (should throw Zod error).
  - OAuth token that expires exactly at the refresh threshold.
  - Rate limiter with burst requests followed by steady state.
  - Circuit breaker at exact threshold boundary.
  - HTTP client with special characters in query parameters.
- **Coverage reporting**: Run `vitest --coverage` and verify the threshold in vitest config.

## Token Estimation Rationale

| Component | Tokens |
|-----------|--------|
| Config system tests (4-5 test files, ~15 test cases) | 6K |
| Auth strategy tests (3 files, ~20 test cases) | 8K |
| HTTP client tests (1 file, ~12 test cases) | 5K |
| Rate limiter tests (1 file, ~8 test cases) | 4K |
| Retry handler tests (1 file, ~10 test cases) | 4K |
| Circuit breaker tests (1 file, ~10 test cases) | 4K |
| Test utilities and mock helpers | 2K |
| Debugging and iteration buffer | 2K |
| **Total** | **35K** |
