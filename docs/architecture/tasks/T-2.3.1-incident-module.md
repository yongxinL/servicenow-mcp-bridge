# Task T-2.3.1: Incident Module

## Meta
| Field | Value |
|-------|-------|
| Task ID | T-2.3.1 |
| Milestone | M2 - Priority Modules |
| Module | Incident Management |
| Priority | High |
| Effort | 5h |
| Estimated Tokens | 30K |
| Recommended Model | Sonnet |
| Dependencies | T-1.5.2 (module registry), T-1.4.1 (error normalizer) |
| Parallel Group | PG-4 |
| AC Mapping | AC-006 |

## Objective

Implement the Incident module providing semantic access to ServiceNow's `incident` table. This is one of the most commonly used ServiceNow modules and a key differentiator for AI assistants. Read operations (`list_incidents`, `get_incident`) are always registered. Write operations (`create_incident`, `update_incident`, `resolve_incident`, `add_incident_comment`) are conditionally registered based on the `incident.allow_write` configuration flag. Tool parameters use semantic names (e.g., `state`, `priority`, `assigned_to`) that map to ServiceNow field names for improved AI discoverability.

## Acceptance Criteria

- **AC-006**: Given a valid ServiceNow instance, when `list_incidents` is called with `state=new` and `limit=5`, then the server returns a structured result with up to 5 incident records filtered by state.
- `list_incidents` tool accepts semantic filter parameters: `state` (optional, e.g., "new", "in_progress", "resolved"), `priority` (optional), `assigned_to` (optional), `category` (optional), `query` (optional raw sysparm_query), `limit` (optional, default 10), `offset` (optional), `order_by` (optional).
- `get_incident` tool accepts `sys_id` or `number` (at least one required), returns full incident record.
- `create_incident` tool accepts `short_description` (required), `description` (optional), `category` (optional), `priority` (optional), `assigned_to` (optional), `assignment_group` (optional), `impact` (optional), `urgency` (optional).
- `update_incident` tool accepts `sys_id` (required) and `fields` (required key-value object).
- `resolve_incident` tool accepts `sys_id` (required), `close_code` (required), `close_notes` (required), sets state to resolved.
- `add_incident_comment` tool accepts `sys_id` (required) and `comment` (required), adds a work note or comment.
- All tool input schemas use Zod with `.describe()` annotations for AI discoverability.
- Module implements the `ServiceNowModule` interface.
- All errors returned as MCP-compliant `CallToolResult` with `isError: true`.

## Technical Notes

- **Module structure**: Create `src/modules/incident/index.ts` (module definition + registration) and `src/modules/incident/tools.ts` (tool handlers).
- **Table**: `incident` -- ServiceNow's incident table.
- **Semantic parameter mapping**: Convert semantic parameter values to ServiceNow encoded query format. For example:
  - `state: "new"` maps to `state=1` (ServiceNow uses numeric values: 1=New, 2=In Progress, 3=On Hold, 6=Resolved, 7=Closed).
  - `priority: "high"` maps to `priority=2` (1=Critical, 2=High, 3=Moderate, 4=Low, 5=Planning).
  - Consider accepting both semantic names and numeric values for flexibility.
- **Query building**: When multiple filter parameters are provided, combine them with `^` (AND) in the `sysparm_query` string. If a raw `query` is also provided, append it to the constructed query.
- **Resolve incident**: The `resolve_incident` tool is a convenience wrapper that updates the incident with `state=6`, `close_code`, and `close_notes` in a single API call.
- **Add comment**: Use ServiceNow's Table API PATCH to update `comments` or `work_notes` field. Decide on `comments` (customer-visible) vs `work_notes` (internal) -- consider adding a `type` parameter defaulting to `work_notes`.
- **Default fields for list**: Return a curated field set by default: `sys_id`, `number`, `short_description`, `state`, `priority`, `assigned_to`, `assignment_group`, `category`, `sys_created_on`, `sys_updated_on`.
- **Display values**: Use `sysparm_display_value=true` for list/get operations so AI assistants see human-readable values (e.g., "High" instead of "2") in responses.
- **Write-gating pattern**: Check `config.modules.incident.allow_write` before registering write tools.
- **Error handling**: Use the error normalizer for all ServiceNow API errors.

## Token Estimation Rationale

| Component | Tokens |
|-----------|--------|
| Module scaffolding (index.ts, interface implementation) | 3K |
| Tool definitions with Zod schemas (6 tools) | 10K |
| Tool handler implementations (semantic mapping, CRUD) | 8K |
| Semantic parameter value mapping (state, priority) | 3K |
| Write-gating logic and config integration | 2K |
| Error handling and response formatting | 2K |
| Debugging and iteration buffer | 2K |
| **Total** | **30K** |
