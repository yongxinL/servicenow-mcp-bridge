# Task T-1.4.1: Error Normalizer

## Meta
| Field | Value |
|-------|-------|
| Task ID | T-1.4.1 |
| Milestone | M1: Foundation |
| Module | M1-MOD4: Error Handling & Logging |
| Priority | High |
| Effort | 4h |
| Estimated Tokens | 22K |
| Recommended Model | Sonnet |
| Dependencies | T-1.2.2 |
| Parallel Group | PG-3 |
| AC Mapping | AC-009, AC-010, AC-011, AC-012, AC-020 |

## Objective
Implement an error normalizer that maps HTTP errors, network errors, and circuit breaker errors into MCP-compliant `CallToolResult` objects with `isError: true`. Define a comprehensive error code enum and provide a builder for constructing structured, user-friendly error responses that MCP clients can parse and display. Also handle the edge case of empty result sets (HTTP 200 with an empty `result` array), which should not be treated as errors.

## Acceptance Criteria
- [ ] Error code enum defines: `VALIDATION_ERROR`, `AUTHENTICATION_ERROR`, `AUTHORIZATION_ERROR`, `NOT_FOUND`, `RATE_LIMITED`, `SERVER_ERROR`, `NETWORK_ERROR`, `CIRCUIT_OPEN` (AC-009 through AC-012)
- [ ] HTTP status code mapping: 400 -> VALIDATION_ERROR, 401 -> AUTHENTICATION_ERROR, 403 -> AUTHORIZATION_ERROR, 404 -> NOT_FOUND, 429 -> RATE_LIMITED, 500+ -> SERVER_ERROR
- [ ] Network errors (TypeError from fetch, AbortError from timeout) mapped to NETWORK_ERROR
- [ ] CircuitOpenError mapped to CIRCUIT_OPEN
- [ ] MCP error response format: `CallToolResult` with `isError: true` and structured text content (AC-020)
- [ ] Error responses include: error code, human-readable message, and (when safe) contextual details
- [ ] No internal implementation details (stack traces, internal URLs, credentials) are leaked in error responses
- [ ] Empty result sets (200 with `result: []`) are handled gracefully — returned as a valid (non-error) response with a descriptive message (AC-020)
- [ ] Unit tests verify: each HTTP status mapping, network error mapping, circuit open mapping, empty result handling, no sensitive data leakage

## Technical Notes

### File Structure
```
src/errors/
  index.ts       # Error normalizer — normalizeError() function + empty result handler
  types.ts       # Error code enum + structured error types
  mcp-error.ts   # MCP CallToolResult error builder
```

### Error Code Enum
```typescript
export enum ServiceNowErrorCode {
  VALIDATION_ERROR = "VALIDATION_ERROR",
  AUTHENTICATION_ERROR = "AUTHENTICATION_ERROR",
  AUTHORIZATION_ERROR = "AUTHORIZATION_ERROR",
  NOT_FOUND = "NOT_FOUND",
  RATE_LIMITED = "RATE_LIMITED",
  SERVER_ERROR = "SERVER_ERROR",
  NETWORK_ERROR = "NETWORK_ERROR",
  CIRCUIT_OPEN = "CIRCUIT_OPEN",
}
```

### Error Normalization Function
```typescript
import type { CallToolResult } from "@modelcontextprotocol/sdk/types.js";

export function normalizeError(error: unknown): CallToolResult {
  if (error instanceof ServiceNowHttpError) {
    return httpErrorToResult(error);
  }
  if (error instanceof CircuitOpenError) {
    return buildErrorResult(
      ServiceNowErrorCode.CIRCUIT_OPEN,
      "Service temporarily unavailable. Circuit breaker is open.",
      `Reset in approximately ${Math.ceil(error.remainingMs / 1000)} seconds.`,
    );
  }
  if (error instanceof TypeError) {
    return buildErrorResult(
      ServiceNowErrorCode.NETWORK_ERROR,
      "Unable to connect to ServiceNow instance.",
      "Check that the instance URL is correct and the network is reachable.",
    );
  }
  if (error instanceof DOMException && error.name === "AbortError") {
    return buildErrorResult(
      ServiceNowErrorCode.NETWORK_ERROR,
      "Request to ServiceNow timed out.",
      "The request exceeded the configured timeout. Try again or increase the timeout.",
    );
  }
  // Unknown error fallback
  return buildErrorResult(
    ServiceNowErrorCode.SERVER_ERROR,
    "An unexpected error occurred.",
    undefined,
  );
}
```

### HTTP Status Code Mapping
```typescript
function httpErrorToResult(error: ServiceNowHttpError): CallToolResult {
  const mapping: Record<number, { code: ServiceNowErrorCode; message: string }> = {
    400: { code: ServiceNowErrorCode.VALIDATION_ERROR, message: "Invalid request. Check your query parameters and field values." },
    401: { code: ServiceNowErrorCode.AUTHENTICATION_ERROR, message: "Authentication failed. Check your ServiceNow credentials." },
    403: { code: ServiceNowErrorCode.AUTHORIZATION_ERROR, message: "Access denied. Your account lacks the required ACL permissions." },
    404: { code: ServiceNowErrorCode.NOT_FOUND, message: "Record or table not found." },
    429: { code: ServiceNowErrorCode.RATE_LIMITED, message: "ServiceNow rate limit exceeded. Try again shortly." },
  };

  const match = mapping[error.statusCode];
  if (match) {
    return buildErrorResult(match.code, match.message, sanitizeErrorBody(error.body));
  }

  if (error.statusCode >= 500) {
    return buildErrorResult(
      ServiceNowErrorCode.SERVER_ERROR,
      "ServiceNow server error. Try again later.",
      sanitizeErrorBody(error.body),
    );
  }

  // Unmapped 4xx
  return buildErrorResult(
    ServiceNowErrorCode.VALIDATION_ERROR,
    `Request failed with status ${error.statusCode}.`,
    sanitizeErrorBody(error.body),
  );
}
```

### MCP Error Result Builder
```typescript
export function buildErrorResult(
  code: ServiceNowErrorCode,
  message: string,
  details?: string,
): CallToolResult {
  const text = details
    ? `[${code}] ${message}\n\nDetails: ${details}`
    : `[${code}] ${message}`;

  return {
    content: [{ type: "text", text }],
    isError: true,
  };
}
```

### Empty Result Set Handling
```typescript
export function buildEmptyResultResponse(table: string, query?: string): CallToolResult {
  const message = query
    ? `No records found in table "${table}" matching query: ${query}`
    : `No records found in table "${table}".`;

  return {
    content: [{ type: "text", text: message }],
    isError: false,  // Not an error — valid empty result
  };
}
```

### Error Body Sanitization
```typescript
function sanitizeErrorBody(body: string): string | undefined {
  if (!body) return undefined;

  try {
    const parsed = JSON.parse(body);
    // Extract ServiceNow error message if available
    if (parsed?.error?.message) {
      return parsed.error.message;
    }
    if (parsed?.error?.detail) {
      return parsed.error.detail;
    }
  } catch {
    // Not JSON — return truncated raw body if it's safe
  }

  // Truncate long error bodies and strip potential sensitive content
  const truncated = body.substring(0, 500);
  // Strip anything that looks like a stack trace or internal path
  if (truncated.includes("at ") || truncated.includes("/opt/") || truncated.includes("\\node_modules\\")) {
    return undefined; // Don't expose internal details
  }

  return truncated;
}
```

### Key Decisions
- **No stack traces in error responses**: Stack traces are logged (via the logger, T-1.4.2) but never returned to MCP clients.
- **Error body sanitization**: ServiceNow error response bodies are parsed to extract the user-facing `error.message` field. Internal details are stripped.
- **Empty results are NOT errors**: HTTP 200 with `result: []` is a valid response indicating no matching records. The `isError: false` flag ensures MCP clients don't treat it as a failure.
- **Unknown errors return generic message**: To prevent information leakage, unrecognized errors produce a generic "unexpected error" message.
- **Text content type**: Error responses use `{ type: "text", text: ... }` content format for broad MCP client compatibility.

### Testing Strategy
- **HTTP status mapping**: For each status code (400, 401, 403, 404, 429, 500, 502, 503), create a `ServiceNowHttpError` and verify the correct error code and message
- **Network errors**: Create `TypeError` and `AbortError`; verify NETWORK_ERROR mapping
- **Circuit open**: Create `CircuitOpenError`; verify CIRCUIT_OPEN mapping
- **Empty results**: Verify `buildEmptyResultResponse` produces `isError: false` response
- **Sanitization**: Verify stack traces and internal paths are stripped from error details
- **Unknown errors**: Pass a plain `Error`; verify generic SERVER_ERROR response

## Token Estimation Rationale
| Component | Tokens |
|-----------|--------|
| Error code enum and types (types.ts) | 2K |
| Error normalizer logic (index.ts) | 6K |
| MCP error result builder (mcp-error.ts) | 3K |
| Error body sanitization | 3K |
| Unit tests (all mappings, edge cases) | 6K |
| Debugging buffer (10%) | 2K |
| **Total** | **22K** |
