# Task T-2.2.1: Knowledge Base Module

## Meta
| Field | Value |
|-------|-------|
| Task ID | T-2.2.1 |
| Milestone | M2 - Priority Modules |
| Module | Knowledge Base |
| Priority | High (Priority 1) |
| Effort | 5h |
| Estimated Tokens | 30K |
| Recommended Model | Sonnet |
| Dependencies | T-1.5.2 (module registry), T-1.4.1 (error normalizer) |
| Parallel Group | PG-4 |
| AC Mapping | AC-002, AC-003, AC-004, AC-005 |

## Objective

Implement the Knowledge Base module as the highest-priority domain module (user priority #1). This module provides semantic access to ServiceNow's `kb_knowledge` table, enabling AI assistants to search and retrieve knowledge articles. Read operations (`search_knowledge`, `get_article`) are always registered. Write operations (`create_article`, `update_article`) are conditionally registered based on the `knowledge.allow_write` configuration flag.

## Acceptance Criteria

- **AC-002**: Given a module config with `knowledge.enabled=true`, `knowledge.allow_write=false`, when the server starts, then only read-only knowledge tools (`search_knowledge`, `get_article`) are registered -- no `create_article` or `update_article` appear in `tools/list`.
- **AC-003**: Given `knowledge.enabled=true` and `knowledge.allow_write=true`, when the server starts, then all knowledge tools including `create_article` and `update_article` are registered.
- **AC-004**: Given a valid ServiceNow instance, when `search_knowledge` is called with a search term, then the server returns a structured result with matching articles including title, short_description, and sys_id.
- **AC-005**: Given a valid ServiceNow instance, when `create_article` is called with required fields (and `allow_write=true`), then a new knowledge article is created and the response includes the `sys_id` and `number`.
- `search_knowledge` tool accepts `query` (required search term), `limit` (optional, default 10), `fields` (optional).
- `get_article` tool accepts `sys_id` (required), returns full article content.
- `create_article` tool accepts `short_description` (required), `text` (required), `kb_knowledge_base` (optional), `kb_category` (optional).
- `update_article` tool accepts `sys_id` (required), `fields` (required key-value object with updatable fields).
- All tool input schemas use Zod with `.describe()` annotations for AI discoverability.
- Module implements the `ServiceNowModule` interface.
- All errors returned as MCP-compliant `CallToolResult` with `isError: true`.

## Technical Notes

- **Module structure**: Create `src/modules/knowledge/index.ts` (module definition + registration) and `src/modules/knowledge/tools.ts` (tool handlers).
- **Table**: `kb_knowledge` -- ServiceNow's knowledge article table.
- **Search implementation**: Use `sysparm_query` with encoded query targeting `short_description` and `text` fields. Example query: `short_descriptionLIKE{term}^ORtextLIKE{term}`. Consider also supporting `workflow_state=published` filter to return only published articles by default.
- **Default fields**: When no fields are specified for search, return a sensible default set: `sys_id`, `number`, `short_description`, `text`, `kb_knowledge_base`, `workflow_state`, `sys_updated_on`.
- **Write-gating pattern**: Same pattern as generic module -- check `config.modules.knowledge.allow_write` before registering `create_article` and `update_article`.
- **Semantic parameters**: Use descriptive, domain-specific parameter names (e.g., `short_description` instead of generic `title`) that map directly to ServiceNow field names. This improves AI tool selection accuracy.
- **Response formatting**: For `search_knowledge`, include result count and indicate if more results are available (pagination hint). For `get_article`, return the full article including text/body content.
- **Error handling**: Use the error normalizer for all ServiceNow API errors. Pay special attention to 403 errors which may indicate the user lacks `knowledge` role.

## Token Estimation Rationale

| Component | Tokens |
|-----------|--------|
| Module scaffolding (index.ts, interface implementation) | 3K |
| Tool definitions with Zod schemas (4 tools) | 8K |
| Tool handler implementations (search logic, CRUD) | 9K |
| Write-gating logic and config integration | 3K |
| Error handling and response formatting | 4K |
| Debugging and iteration buffer | 3K |
| **Total** | **30K** |
