# Task T-4.3.2: Final Quality Pass

## Meta
| Field | Value |
|-------|-------|
| Task ID | T-4.3.2 |
| Milestone | M4 - Testing & Polish |
| Module | Quality Assurance |
| Priority | High |
| Effort | 2h |
| Estimated Tokens | 10K |
| Recommended Model | Haiku |
| Dependencies | T-4.1.3 (integration tests), T-4.2.1 (HTTP transport) |
| Parallel Group | -- |
| AC Mapping | -- |

## Objective

Perform a final quality pass across the entire codebase to ensure production readiness. Run full lint, type-check, and test coverage reports. Verify the test coverage meets the >=70% threshold (targeting 85%). Fix any remaining lint errors, type errors, or test failures. Verify zero critical or high security issues in dependencies.

## Acceptance Criteria

- `npx tsc --noEmit` completes with zero type errors across the entire codebase.
- `npm run lint` (ESLint) completes with zero errors (warnings are acceptable but should be reviewed).
- `npm run test` (vitest) passes all unit and integration tests with zero failures.
- `npm run test:coverage` (vitest with coverage) reports >=70% line coverage overall, with >=85% on `src/core/` directory.
- `npm audit` reports zero critical or high severity vulnerabilities in production dependencies.
- No `any` types used in production code (TypeScript strict mode enforced).
- No `console.log` statements in production code (all logging via the structured logger to stderr).
- No hardcoded credentials, URLs, or instance names in source code.
- All source files have consistent formatting (prettier or equivalent).
- package.json `scripts` section includes all necessary commands: `build`, `start`, `dev`, `test`, `test:coverage`, `lint`, `typecheck`.
- Build output (`npm run build`) succeeds and produces clean JavaScript output.

## Technical Notes

- **Execution checklist** (run in this order):
  1. `npx tsc --noEmit` -- catch type errors first.
  2. `npm run lint` -- fix lint errors.
  3. `npm run test` -- verify all tests pass.
  4. `npm run test:coverage` -- check coverage thresholds.
  5. `npm audit` -- check for vulnerable dependencies.
  6. `npm run build` -- verify clean build output.

- **Common issues to fix**:
  - Unused imports or variables (TypeScript/ESLint).
  - Missing return types on exported functions.
  - Inconsistent error handling patterns.
  - Missing `.describe()` on Zod schema fields.
  - `console.log` accidentally left in source code.
  - Test files importing from incorrect paths after refactoring.

- **Coverage configuration**: Verify vitest config includes coverage thresholds:
  ```typescript
  // vitest.config.ts
  test: {
    coverage: {
      provider: 'v8',
      thresholds: {
        lines: 70,
        branches: 70,
        functions: 70,
        statements: 70,
      }
    }
  }
  ```

- **Security scan**: Run `npm audit` and review results. If critical/high vulnerabilities exist:
  - Check if they affect production dependencies (not just devDependencies).
  - Run `npm audit fix` for automatically fixable issues.
  - Document any unfixable issues with justification if they are in devDependencies only.

- **Final review checklist**:
  - [ ] All acceptance criteria from AC-001 through AC-021 are addressed by tests.
  - [ ] Environment variable names are consistent between code, config schema, and documentation.
  - [ ] Error messages are descriptive and actionable.
  - [ ] All ServiceNow API calls go through the centralized HTTP client (no direct fetch calls in modules).
  - [ ] Module registration follows the standard `ServiceNowModule` interface.

- **Haiku-suitable**: This task is primarily mechanical (run commands, fix issues) and does not require architectural decisions. The checklist-driven approach is well suited for a smaller/faster model.

## Token Estimation Rationale

| Component | Tokens |
|-----------|--------|
| Running lint, type-check, test commands and analyzing output | 2K |
| Fixing type errors and lint issues | 3K |
| Coverage analysis and gap identification | 1K |
| Security audit review | 1K |
| Build verification | 1K |
| Debugging and iteration buffer | 2K |
| **Total** | **10K** |
