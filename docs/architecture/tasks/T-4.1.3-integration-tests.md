# Task T-4.1.3: Integration Tests

## Meta
| Field | Value |
|-------|-------|
| Task ID | T-4.1.3 |
| Milestone | M4 - Testing & Polish |
| Module | End-to-End Testing |
| Priority | High |
| Effort | 6h |
| Estimated Tokens | 40K |
| Recommended Model | Sonnet |
| Dependencies | T-2.1.1 (generic module), T-2.2.1 (knowledge module), T-2.3.1 (incident module) |
| Parallel Group | -- |
| AC Mapping | AC-001, AC-002, AC-003, AC-004, AC-005, AC-006, AC-007, AC-008, AC-009, AC-010, AC-011, AC-012 |

## Objective

Create end-to-end integration tests that validate the complete MCP server pipeline -- from MCP client request through tool dispatch to ServiceNow API call and back. Tests use the MCP SDK's in-memory transport (no real network) with mock ServiceNow HTTP responses. This validates that all components (server initialization, module registration, tool execution, error handling) work together correctly.

## Acceptance Criteria

- **Server startup and initialization**:
  - **AC-001**: Given valid configuration with `auth.type=basic`, when the server starts via stdio, then it connects successfully and responds to MCP `initialize` request with server name and version.
  - Server starts within 5 seconds and reaches ready state.

- **Tool listing and write flag behavior**:
  - **AC-002**: Given `knowledge.enabled=true`, `knowledge.allow_write=false`, when `tools/list` is called, then only `search_knowledge` and `get_article` appear -- no `create_article` or `update_article`.
  - **AC-003**: Given `knowledge.enabled=true`, `knowledge.allow_write=true`, when `tools/list` is called, then all knowledge tools including `create_article` and `update_article` appear.
  - **AC-008**: Given `generic.allow_write=false`, when `tools/list` is called, then only `query_records` and `get_record` are listed -- no `create_record`, `update_record`, `delete_record`.
  - Verify tool count matches expected number for the given configuration.

- **Tool execution with mock responses**:
  - **AC-004**: Execute `search_knowledge` with a search term, mock ServiceNow returning matching articles, verify structured result with title, short_description, and sys_id.
  - **AC-005**: Execute `create_article` (with `allow_write=true`), mock ServiceNow returning created record, verify response includes sys_id and number.
  - **AC-006**: Execute `list_incidents` with `state=new` and `limit=5`, mock ServiceNow returning filtered results, verify structured result with up to 5 records.
  - **AC-007**: Execute `query_records` with table, query filter, and field list, mock ServiceNow returning matching records, verify only requested fields are present.

- **Error scenarios**:
  - **AC-009**: Mock ServiceNow returning 401 (invalid credentials), verify MCP error result with `isError: true` and `AUTHENTICATION_ERROR` code.
  - **AC-010**: Mock ServiceNow returning 403 (forbidden), verify MCP error result with `AUTHORIZATION_ERROR` code.
  - **AC-011**: Mock ServiceNow returning 404 (not found), verify MCP error result with `NOT_FOUND` code.
  - **AC-012**: Mock ServiceNow returning 200 with empty result array, verify successful MCP result with empty array and "no records found" metadata.
  - Test network error (mock fetch throwing), verify `NETWORK_ERROR` result.

## Technical Notes

- **Test framework**: vitest with MCP SDK test utilities.
- **Test file location**: `tests/integration/` directory.
- **In-memory transport**: Use the MCP SDK's `InMemoryTransport` or `StdioClientTransport` with piped streams to create a client-server pair without real network connections. This is the standard pattern for MCP server integration testing.
  ```typescript
  import { Client } from "@modelcontextprotocol/sdk/client/index.js";
  import { InMemoryTransport } from "@modelcontextprotocol/sdk/inMemory.js";
  ```
- **Mock HTTP responses**: Intercept the ServiceNow HTTP client's `fetch` calls using vitest mocks or msw (Mock Service Worker). Create realistic ServiceNow API response fixtures:
  ```typescript
  const mockKnowledgeResults = {
    result: [
      { sys_id: "abc123", number: "KB0010001", short_description: "How to reset password", text: "..." },
    ]
  };
  ```
- **Test organization**:
  - `tests/integration/server-lifecycle.test.ts` -- startup, initialize, shutdown
  - `tests/integration/tool-registration.test.ts` -- tool listing with various configs
  - `tests/integration/knowledge-tools.test.ts` -- knowledge module tool execution
  - `tests/integration/incident-tools.test.ts` -- incident module tool execution
  - `tests/integration/generic-tools.test.ts` -- generic module tool execution
  - `tests/integration/error-scenarios.test.ts` -- all error code paths
- **Configuration for tests**: Create test-specific config objects that override defaults. Use different configs per test to verify write flag behavior.
- **Response fixture files**: Consider creating `tests/fixtures/` directory with JSON files for ServiceNow response payloads to keep test files clean.
- **Assertions**: Verify the full MCP response structure, not just individual fields. Check `content[0].type === "text"` and parse the text content to verify the ServiceNow data is correctly formatted.

## Token Estimation Rationale

| Component | Tokens |
|-----------|--------|
| Test infrastructure (setup, helpers, transport config) | 5K |
| Server lifecycle tests | 4K |
| Tool registration tests (write flag permutations) | 6K |
| Knowledge tool execution tests | 5K |
| Incident tool execution tests | 5K |
| Generic tool execution tests | 4K |
| Error scenario tests (6+ scenarios) | 6K |
| Mock response fixtures | 3K |
| Debugging and iteration buffer | 2K |
| **Total** | **40K** |
