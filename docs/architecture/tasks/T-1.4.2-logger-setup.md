# Task T-1.4.2: Logger Setup

## Meta
| Field | Value |
|-------|-------|
| Task ID | T-1.4.2 |
| Milestone | M1: Foundation |
| Module | M1-MOD4: Error Handling & Logging |
| Priority | Medium |
| Effort | 2h |
| Estimated Tokens | 12K |
| Recommended Model | Haiku |
| Dependencies | T-1.1.1 |
| Parallel Group | PG-2 |
| AC Mapping | AC-019 |

## Objective
Set up Pino v9 as the structured JSON logger, configured to write exclusively to stderr (stdout is reserved for MCP protocol communication). Provide a child logger factory that injects correlation IDs for request tracing. Implement standardized API call logging with method, table, duration_ms, and status_code fields. Include credential redaction to prevent sensitive data from appearing in logs.

## Acceptance Criteria
- [ ] Pino v9 logger writes structured JSON to stderr (not stdout) (AC-019)
- [ ] Log level is configurable via the configuration system (defaults to `"info"`)
- [ ] Child logger factory creates loggers with injected correlation IDs
- [ ] API call logging helper logs: `method`, `table`, `duration_ms`, `status_code` fields
- [ ] Credential redaction: passwords, tokens, client secrets, and authorization headers are never logged in plain text
- [ ] Logger is exported as a singleton for use across all modules
- [ ] Unit tests verify: stderr output, child logger correlation IDs, redaction of sensitive fields

## Technical Notes

### File Structure
```
src/logging/
  index.ts    # Logger setup, child factory, API call logger, redaction
```

### Logger Initialization
```typescript
import pino from "pino";

export function createLogger(level: string = "info"): pino.Logger {
  return pino({
    level,
    // Write to stderr â€” stdout is reserved for MCP protocol
    transport: undefined, // Use default destination
    redact: {
      paths: [
        "password",
        "*.password",
        "token",
        "*.token",
        "client_secret",
        "*.client_secret",
        "authorization",
        "*.authorization",
        "headers.authorization",
        "headers.Authorization",
      ],
      censor: "[REDACTED]",
    },
  }, pino.destination(2)); // fd 2 = stderr
}
```

### Child Logger Factory
```typescript
let requestCounter = 0;

export function createChildLogger(
  parent: pino.Logger,
  context?: Record<string, unknown>,
): pino.Logger {
  const correlationId = `req-${++requestCounter}-${Date.now().toString(36)}`;
  return parent.child({ correlationId, ...context });
}
```

Correlation IDs are simple incrementing counters with a timestamp suffix. This is sufficient for a single-process server. For distributed tracing, a UUID would be more appropriate (future consideration).

### API Call Logger
```typescript
export interface ApiCallLogData {
  method: string;       // "GET", "POST", "PATCH", "DELETE"
  table: string;        // ServiceNow table name
  duration_ms: number;  // Request duration in milliseconds
  status_code: number;  // HTTP response status code
  sys_id?: string;      // Optional record ID
}

export function logApiCall(logger: pino.Logger, data: ApiCallLogData): void {
  logger.info(data, `${data.method} ${data.table} -> ${data.status_code} (${data.duration_ms}ms)`);
}
```

Usage from the ServiceNow client:
```typescript
const start = Date.now();
const response = await fetch(url, options);
logApiCall(logger, {
  method: "GET",
  table: "incident",
  duration_ms: Date.now() - start,
  status_code: response.status,
});
```

### Redaction Configuration
Pino's built-in `redact` option handles credential redaction declaratively. The paths configuration covers:
- Direct credential fields (`password`, `token`, `client_secret`)
- Nested credential fields (`*.password`, `*.token`, etc.)
- HTTP authorization headers (`headers.authorization`, `headers.Authorization`)

Any log call that includes these fields will have their values replaced with `[REDACTED]`.

### Singleton Export
```typescript
// Initialized during server startup, then imported by all modules
let _logger: pino.Logger;

export function initializeLogger(level: string): pino.Logger {
  _logger = createLogger(level);
  return _logger;
}

export function getLogger(): pino.Logger {
  if (!_logger) {
    // Fallback for cases where logger is accessed before initialization
    _logger = createLogger("info");
  }
  return _logger;
}
```

### Key Decisions
- **Pino over Winston/Bunyan** (ADR-005): Pino is the fastest Node.js JSON logger. JSON output with no formatting overhead. Native child logger support.
- **stderr only**: MCP protocol uses stdout for JSON-RPC messages. Any log output to stdout would corrupt the protocol stream. Pino's `destination(2)` ensures logs go to file descriptor 2 (stderr).
- **Declarative redaction**: Using Pino's built-in `redact` option instead of manual string replacement. More reliable and maintainable.
- **No log rotation**: Log rotation is handled by the container runtime or process manager (systemd, Docker, etc.), not by the application.
- **Simple correlation IDs**: Counter-based IDs are sufficient for single-process debugging. No UUID dependency needed.

### Testing Strategy
- **stderr output**: Capture stderr and verify JSON log output is written there (not stdout)
- **Log level**: Set level to "warn"; verify "info" messages are suppressed
- **Child logger**: Create child with correlation ID; verify it appears in log output
- **API call logging**: Call `logApiCall` with test data; verify all fields appear in structured output
- **Redaction**: Log an object containing `password`, `token`, `authorization`; verify all are replaced with `[REDACTED]`
- **Singleton**: Verify `getLogger()` returns the same instance after initialization

## Token Estimation Rationale
| Component | Tokens |
|-----------|--------|
| Pino logger initialization | 2K |
| Child logger factory + correlation IDs | 2K |
| API call logger helper | 2K |
| Redaction configuration | 1K |
| Unit tests (stderr, redaction, child loggers) | 3K |
| Debugging buffer (15%) | 2K |
| **Total** | **12K** |
