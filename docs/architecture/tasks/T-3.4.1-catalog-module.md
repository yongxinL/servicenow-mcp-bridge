# Task T-3.4.1: Catalog Module

## Meta
| Field | Value |
|-------|-------|
| Task ID | T-3.4.1 |
| Milestone | M3 - Extended Modules |
| Module | Service Catalog |
| Priority | Low |
| Effort | 3h |
| Estimated Tokens | 20K |
| Recommended Model | Sonnet |
| Dependencies | T-1.5.2 (module registry), T-1.4.1 (error normalizer) |
| Parallel Group | PG-5 |
| AC Mapping | -- |

## Objective

Implement the Service Catalog module providing semantic access to ServiceNow's catalog items and service requests. This module enables AI assistants to browse available catalog items and submit requests on behalf of users. Read operations (`list_catalog_items`, `get_catalog_item`, `get_request_status`) are always registered. The write operation (`submit_catalog_request`) is conditionally registered based on the `catalog.allow_write` configuration flag.

## Acceptance Criteria

- `list_catalog_items` tool accepts `category` (optional), `query` (optional search term), `active` (optional, default true), `limit` (optional, default 10), `offset` (optional).
- `get_catalog_item` tool accepts `sys_id` (required), returns full catalog item details including name, description, price, category, and available variables/form fields.
- `get_request_status` tool accepts `sys_id` or `number` (at least one required), returns the request record from `sc_request` with current state and approval status.
- `submit_catalog_request` tool accepts `catalog_item_sys_id` (required), `requested_for` (optional, defaults to current user), `variables` (optional key-value object with catalog item variable values), `quantity` (optional, default 1).
- Given `catalog.allow_write=false`, only `list_catalog_items`, `get_catalog_item`, and `get_request_status` are registered.
- Given `catalog.allow_write=true`, all four tools are registered.
- All tool input schemas use Zod with `.describe()` annotations for AI discoverability.
- Module implements the `ServiceNowModule` interface.
- All errors returned as MCP-compliant `CallToolResult` with `isError: true`.

## Technical Notes

- **Module structure**: Create `src/modules/catalog/index.ts` (module definition + registration) and `src/modules/catalog/tools.ts` (tool handlers).
- **Tables**: `sc_cat_item` (catalog items), `sc_request` (service requests), `sc_req_item` (requested items).
- **Catalog item listing**: Query `sc_cat_item` table. Filter by `active=true` by default. Search across `name` and `short_description` fields using `sysparm_query` with `LIKE` operator.
- **Catalog item details**: When getting a catalog item, include the `sc_cat_item_category` field for category context. Consider also querying related catalog variables (`item_option_new` table) to show what form fields are available -- but this may add complexity. For v0.1.0, return the item record fields only.
- **Submit catalog request**: Use the ServiceNow Service Catalog API endpoint if available (`/api/sn_sc/servicecatalog/items/{sys_id}/order_now`), or fall back to creating records directly on `sc_request` and `sc_req_item` tables. The direct table approach is simpler and does not require additional API plugins.
- **Request status**: Query `sc_request` table. Include related `sc_req_item` records for detailed status of individual items within the request.
- **Default fields for catalog items**: Return `sys_id`, `name`, `short_description`, `description`, `category`, `price`, `active`, `order`, `sys_updated_on`.
- **Default fields for request status**: Return `sys_id`, `number`, `request_state`, `stage`, `requested_for`, `opened_at`, `sys_updated_on`.
- **Follow patterns from**: T-2.2.1 (Knowledge module) for read-heavy module structure with conditional write.

## Token Estimation Rationale

| Component | Tokens |
|-----------|--------|
| Module scaffolding (index.ts, interface implementation) | 3K |
| Tool definitions with Zod schemas (4 tools) | 6K |
| Tool handler implementations | 5K |
| Catalog request submission logic | 2K |
| Write-gating logic and config integration | 1K |
| Error handling and response formatting | 1K |
| Debugging and iteration buffer | 2K |
| **Total** | **20K** |
