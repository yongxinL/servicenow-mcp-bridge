# Task T-1.2.2: HTTP Client

## Meta
| Field | Value |
|-------|-------|
| Task ID | T-1.2.2 |
| Milestone | M1: Foundation |
| Module | M1-MOD2: ServiceNow Client |
| Priority | High |
| Effort | 5h |
| Estimated Tokens | 28K |
| Recommended Model | Sonnet |
| Dependencies | T-1.1.1 |
| Parallel Group | PG-2 |
| AC Mapping | AC-007 |

## Objective
Implement the `ServiceNowClient` class — the central HTTP client for all ServiceNow API communication. The client handles URL construction from instance names, query parameter serialization (sysparm_*), request execution using native `fetch`, and response parsing. It accepts an `AuthStrategy` for authentication headers and exposes typed methods for `GET`, `POST`, `PATCH`, and `DELETE` operations against the ServiceNow Table API and Aggregate API.

## Acceptance Criteria
- [ ] `ServiceNowClient` class constructs correct base URLs from instance name (e.g., `mycompany` -> `https://mycompany.service-now.com`)
- [ ] Table API URL construction: `/api/now/table/{table}` and `/api/now/table/{table}/{sys_id}` (AC-007)
- [ ] Aggregate API URL construction: `/api/now/stats/{table}`
- [ ] Query parameter serialization handles: `sysparm_query`, `sysparm_limit`, `sysparm_offset`, `sysparm_fields`, `sysparm_display_value`, `sysparm_order_by`
- [ ] Client uses native `fetch` API (no axios, no node-fetch)
- [ ] Client calls `authStrategy.getAuthHeaders()` for every request
- [ ] Client sets `Content-Type: application/json` and `Accept: application/json` headers
- [ ] Response parsing extracts `result` from ServiceNow JSON response envelope
- [ ] Client exposes typed methods: `get<T>()`, `post<T>()`, `patch<T>()`, `delete()`
- [ ] Request/response types are defined in `types.ts`
- [ ] Unit tests verify URL construction, query serialization, header attachment

## Technical Notes

### File Structure
```
src/client/
  index.ts          # ServiceNowClient class
  types.ts          # Request/response TypeScript types
  query-builder.ts  # Query parameter serialization helper
```

### ServiceNowClient Class
```typescript
export class ServiceNowClient {
  private baseUrl: string;

  constructor(
    private instanceName: string,
    private authStrategy: AuthStrategy,
    private config: { timeout: number },
  ) {
    // Support both "mycompany" and "mycompany.service-now.com"
    this.baseUrl = instanceName.includes(".")
      ? `https://${instanceName}`
      : `https://${instanceName}.service-now.com`;
  }

  async get<T>(table: string, params?: QueryParams): Promise<ServiceNowResponse<T>> { ... }
  async getById<T>(table: string, sysId: string, params?: Pick<QueryParams, "sysparm_fields" | "sysparm_display_value">): Promise<T> { ... }
  async post<T>(table: string, body: Record<string, unknown>): Promise<T> { ... }
  async patch<T>(table: string, sysId: string, body: Record<string, unknown>): Promise<T> { ... }
  async delete(table: string, sysId: string): Promise<void> { ... }
  async aggregate<T>(table: string, params?: QueryParams): Promise<ServiceNowResponse<T>> { ... }
}
```

### URL Construction
```typescript
private tableUrl(table: string, sysId?: string): string {
  const base = `${this.baseUrl}/api/now/table/${encodeURIComponent(table)}`;
  return sysId ? `${base}/${sysId}` : base;
}

private aggregateUrl(table: string): string {
  return `${this.baseUrl}/api/now/stats/${encodeURIComponent(table)}`;
}
```

### Query Parameter Serialization (`query-builder.ts`)
```typescript
export interface QueryParams {
  sysparm_query?: string;
  sysparm_limit?: number;
  sysparm_offset?: number;
  sysparm_fields?: string;      // Comma-separated field list
  sysparm_display_value?: "true" | "false" | "all";
  sysparm_order_by?: string;     // e.g., "sys_created_onDESC"
}

export function buildQueryString(params: QueryParams): string {
  const searchParams = new URLSearchParams();
  for (const [key, value] of Object.entries(params)) {
    if (value !== undefined && value !== null) {
      searchParams.set(key, String(value));
    }
  }
  return searchParams.toString();
}
```

### Request Execution Pattern
```typescript
private async request<T>(url: string, options: RequestInit): Promise<T> {
  const authHeaders = await this.authStrategy.getAuthHeaders();
  const response = await fetch(url, {
    ...options,
    headers: {
      "Content-Type": "application/json",
      "Accept": "application/json",
      ...authHeaders,
      ...options.headers,
    },
    signal: AbortSignal.timeout(this.config.timeout),
  });

  if (!response.ok) {
    // Throw structured error — error normalizer (T-1.4.1) will handle mapping
    throw new ServiceNowHttpError(response.status, response.statusText, await response.text());
  }

  const json = await response.json();
  return json;
}
```

### Response Types
```typescript
export interface ServiceNowResponse<T> {
  result: T[];
}

export interface ServiceNowSingleResponse<T> {
  result: T;
}

export class ServiceNowHttpError extends Error {
  constructor(
    public readonly statusCode: number,
    public readonly statusText: string,
    public readonly body: string,
  ) {
    super(`ServiceNow API error: ${statusCode} ${statusText}`);
    this.name = "ServiceNowHttpError";
  }
}
```

### Key Decisions
- **Native `fetch` only** (ADR-002) — no axios, no node-fetch. Requires Node >= 20.
- **`AbortSignal.timeout()`** for request timeouts — clean, built-in timeout mechanism
- **Table name encoding**: `encodeURIComponent(table)` prevents injection but allows valid table names
- **No resilience logic in this class** — rate limiting, retry, and circuit breaker are composed around the client externally (in the resilience layer). This keeps the client focused on HTTP concerns only.
- **Error class**: `ServiceNowHttpError` carries status code, status text, and response body for downstream error normalization

### Testing Strategy
- **URL construction**: Verify table URL, aggregate URL, sys_id URL with various instance name formats
- **Query serialization**: Verify each parameter type, verify undefined values are omitted, verify encoding
- **Headers**: Mock `fetch` to verify Content-Type, Accept, and auth headers are attached
- **Response parsing**: Mock `fetch` to return ServiceNow-shaped responses, verify `result` extraction
- **Error handling**: Mock `fetch` to return error status codes, verify `ServiceNowHttpError` is thrown with correct fields

## Token Estimation Rationale
| Component | Tokens |
|-----------|--------|
| ServiceNowClient class (index.ts) | 8K |
| Request/response types (types.ts) | 3K |
| Query parameter builder (query-builder.ts) | 3K |
| Unit tests (URL, query, headers, response, errors) | 10K |
| Debugging buffer (15%) | 4K |
| **Total** | **28K** |
