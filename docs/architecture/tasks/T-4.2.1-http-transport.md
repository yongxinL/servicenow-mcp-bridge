# Task T-4.2.1: Streamable HTTP Transport

## Meta
| Field | Value |
|-------|-------|
| Task ID | T-4.2.1 |
| Milestone | M4 - Testing & Polish |
| Module | MCP Server Transport |
| Priority | Medium |
| Effort | 4h |
| Estimated Tokens | 25K |
| Recommended Model | Sonnet |
| Dependencies | T-1.5.1 (MCP server setup with stdio transport) |
| Parallel Group | -- |
| AC Mapping | -- |

## Objective

Implement the Streamable HTTP transport as a secondary, config-gated transport option for the MCP server. This enables remote deployments where the MCP client cannot spawn the server as a child process (e.g., web-based clients, remote server deployments). The HTTP transport uses Express.js with session management and is only activated when explicitly enabled via configuration.

## Acceptance Criteria

- HTTP transport is only started when `transport.http.enabled=true` in configuration (default: `false`).
- When enabled, an Express.js server starts on a configurable port (default: 3000, configurable via `transport.http.port`).
- The HTTP transport implements the MCP Streamable HTTP transport specification:
  - POST endpoint for receiving MCP messages.
  - Server-Sent Events (SSE) for streaming responses back to the client.
  - Session management with unique session IDs.
- Multiple concurrent clients can connect and maintain independent sessions.
- The server can run both stdio and HTTP transports simultaneously when both are enabled.
- Health check endpoint (`GET /health`) returns server status, uptime, and connected session count.
- Graceful shutdown -- HTTP server closes cleanly when the process receives SIGTERM/SIGINT, draining active connections.
- Error responses follow MCP specification for transport-level errors.
- All HTTP transport activity is logged via the structured logger (to stderr).

## Technical Notes

- **Implementation location**: `src/transport/http.ts` or `src/transport/streamable-http.ts`.
- **Express.js setup**: Create a minimal Express application with the MCP HTTP transport handler. Use the MCP SDK's built-in HTTP transport support if available:
  ```typescript
  import { StreamableHTTPServerTransport } from "@modelcontextprotocol/sdk/server/streamableHttp.js";
  ```
- **Config gating**: In the server entry point (`src/index.ts`), check `config.transport.http.enabled` before initializing the HTTP transport. The stdio transport should always be available as the primary transport.
- **Session management**: Each connecting client gets a unique session. The MCP SDK's `StreamableHTTPServerTransport` may handle session management internally -- verify SDK capabilities before implementing custom session logic.
- **Configuration schema**: Add to the existing config schema:
  ```typescript
  transport: {
    http: {
      enabled: z.boolean().default(false),
      port: z.number().default(3000),
      host: z.string().default("127.0.0.1"),
    }
  }
  ```
- **Security considerations**:
  - Bind to `127.0.0.1` by default (not `0.0.0.0`) to prevent unintended external access.
  - Consider adding optional API key authentication for the HTTP endpoint in future versions (out of scope for v0.1.0, but document the placeholder).
  - Do not expose ServiceNow credentials via the HTTP interface.
- **Health check endpoint**: Simple `GET /health` route returning:
  ```json
  { "status": "ok", "uptime": 12345, "sessions": 2, "version": "0.1.0" }
  ```
- **Graceful shutdown**: Listen for `SIGTERM` and `SIGINT`, call `server.close()` on the Express instance, and wait for active connections to drain before exiting.
- **Testing**: Add basic tests for HTTP transport startup, health check endpoint, and session creation. Full MCP protocol testing over HTTP can use supertest or similar.

## Token Estimation Rationale

| Component | Tokens |
|-----------|--------|
| Express.js server setup and MCP transport integration | 8K |
| Session management | 4K |
| Config schema additions and gating logic | 3K |
| Health check endpoint | 2K |
| Graceful shutdown handling | 2K |
| Entry point integration (dual transport support) | 2K |
| Basic tests | 2K |
| Debugging and iteration buffer | 2K |
| **Total** | **25K** |
