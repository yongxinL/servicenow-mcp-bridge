# Task T-2.1.1: Generic Module

## Meta
| Field | Value |
|-------|-------|
| Task ID | T-2.1.1 |
| Milestone | M2 - Priority Modules |
| Module | Generic Table Operations |
| Priority | High |
| Effort | 5h |
| Estimated Tokens | 30K |
| Recommended Model | Sonnet |
| Dependencies | T-1.5.2 (module registry), T-1.4.1 (error normalizer) |
| Parallel Group | PG-4 |
| AC Mapping | AC-007, AC-008 |

## Objective

Implement the Generic module that provides direct access to any ServiceNow table via the Table API. This module serves as the "power-user escape hatch," enabling operations on tables that do not have dedicated domain modules. Read operations (`query_records`, `get_record`) are always registered. Write operations (`create_record`, `update_record`, `delete_record`) are conditionally registered based on the `generic.allow_write` configuration flag.

## Acceptance Criteria

- **AC-007**: Given any table name, when `query_records` is called with a table, query filter, and field list, then the server returns matching records with only the requested fields.
- **AC-008**: Given `generic.allow_write=false`, when the server starts, then `create_record`, `update_record`, `delete_record` tools are NOT registered; only `query_records` and `get_record` are available.
- `query_records` tool accepts `table` (required), `query` (optional sysparm_query), `fields` (optional field list), `limit` (optional, default 10), `offset` (optional), `order_by` (optional).
- `get_record` tool accepts `table` (required) and `sys_id` (required), returns a single record.
- `create_record` tool accepts `table` (required) and `fields` (required key-value object), returns created record with `sys_id`.
- `update_record` tool accepts `table` (required), `sys_id` (required), and `fields` (required key-value object), returns updated record.
- `delete_record` tool accepts `table` (required) and `sys_id` (required), returns confirmation.
- All tool input schemas use Zod with `.describe()` annotations for AI discoverability.
- Module implements the `ServiceNowModule` interface with `config` metadata and `register(server, client)` method.
- All errors are returned as MCP-compliant `CallToolResult` with `isError: true` -- never thrown as exceptions.

## Technical Notes

- **Module structure**: Create `src/modules/generic/index.ts` (module definition + registration) and `src/modules/generic/tools.ts` (tool handlers).
- **ServiceNowClient usage**: Use the shared `ServiceNowClient` instance passed via `register(server, client)` for all API calls. Do not instantiate a new client.
- **Zod schemas**: Define input schemas with `.describe()` on every field. Example: `z.string().describe("The ServiceNow table name (e.g., 'incident', 'cmdb_ci')")`.
- **Write gating pattern**: In the `register` method, check `config.modules.generic.allow_write` before registering write tools. Read tools are always registered.
- **Table name validation**: Validate table names against a basic pattern (alphanumeric + underscore) to prevent injection. Do not maintain a hardcoded list of valid tables.
- **Field serialization**: For `create_record` and `update_record`, the `fields` parameter is a `Record<string, string>` passed directly as the JSON body to the ServiceNow Table API.
- **Query parameter mapping**: Map tool parameters to ServiceNow `sysparm_*` query parameters using the client's built-in serialization.
- **Response formatting**: Return the `result` array from ServiceNow's JSON response. Include metadata (count, table name) in the response for AI context.
- **Error handling**: Use the error normalizer (T-1.4.1) to convert ServiceNow HTTP errors into structured MCP error results.

## Token Estimation Rationale

| Component | Tokens |
|-----------|--------|
| Module scaffolding (index.ts, interface implementation) | 3K |
| Tool definitions with Zod schemas (5 tools) | 10K |
| Tool handler implementations | 8K |
| Write-gating logic and config integration | 3K |
| Error handling and response formatting | 3K |
| Debugging and iteration buffer | 3K |
| **Total** | **30K** |
