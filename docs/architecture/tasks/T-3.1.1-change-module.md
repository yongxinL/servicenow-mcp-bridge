# Task T-3.1.1: Change Module

## Meta
| Field | Value |
|-------|-------|
| Task ID | T-3.1.1 |
| Milestone | M3 - Extended Modules |
| Module | Change Management |
| Priority | Medium |
| Effort | 4h |
| Estimated Tokens | 25K |
| Recommended Model | Sonnet |
| Dependencies | T-1.5.2 (module registry), T-1.4.1 (error normalizer) |
| Parallel Group | PG-5 |
| AC Mapping | -- |

## Objective

Implement the Change Management module providing semantic access to ServiceNow's `change_request` table. This module enables AI assistants to list, view, create, update, and manage change requests, including approval workflows and change tasks. Read operations (`list_changes`, `get_change`) are always registered. Write operations (`create_change`, `update_change`, `approve_change`, `add_change_task`) are conditionally registered based on the `change.allow_write` configuration flag.

## Acceptance Criteria

- `list_changes` tool accepts semantic filter parameters: `state` (optional), `type` (optional, e.g., "normal", "standard", "emergency"), `assigned_to` (optional), `category` (optional), `query` (optional raw sysparm_query), `limit` (optional, default 10), `offset` (optional), `order_by` (optional).
- `get_change` tool accepts `sys_id` or `number` (at least one required), returns full change request record.
- `create_change` tool accepts `short_description` (required), `description` (optional), `type` (optional, default "normal"), `category` (optional), `assigned_to` (optional), `assignment_group` (optional), `risk` (optional), `impact` (optional), `start_date` (optional), `end_date` (optional).
- `update_change` tool accepts `sys_id` (required) and `fields` (required key-value object).
- `approve_change` tool accepts `sys_id` (required), sets the approval state appropriately.
- `add_change_task` tool accepts `change_sys_id` (required), `short_description` (required), `description` (optional), `assigned_to` (optional), creates a task linked to the change request on the `change_task` table.
- Given `change.allow_write=false`, only `list_changes` and `get_change` are registered.
- Given `change.allow_write=true`, all six tools are registered.
- All tool input schemas use Zod with `.describe()` annotations for AI discoverability.
- Module implements the `ServiceNowModule` interface.
- All errors returned as MCP-compliant `CallToolResult` with `isError: true`.

## Technical Notes

- **Module structure**: Create `src/modules/change/index.ts` (module definition + registration) and `src/modules/change/tools.ts` (tool handlers).
- **Table**: `change_request` -- ServiceNow's change request table. Change tasks use the `change_task` table.
- **Semantic parameter mapping**: Convert semantic state values to ServiceNow numeric values. Change request states differ from incident states (e.g., -5=New, -4=Assess, -3=Authorize, -2=Scheduled, -1=Implement, 0=Review, 3=Closed, 4=Cancelled).
- **Change types**: Map semantic type names to ServiceNow values: "normal" (Normal), "standard" (Standard), "emergency" (Emergency).
- **Approve change**: Use ServiceNow's approval mechanism. This may involve updating the `approval` field to "approved" or interacting with the approval API depending on the change workflow configured on the instance.
- **Add change task**: Create a record on `change_task` table with `change_request` field set to the parent change's `sys_id`. This is a separate API call to a different table.
- **Default fields for list**: Return `sys_id`, `number`, `short_description`, `state`, `type`, `risk`, `impact`, `assigned_to`, `assignment_group`, `start_date`, `end_date`, `sys_created_on`.
- **Display values**: Use `sysparm_display_value=true` for human-readable field values.
- **Follow patterns from**: T-2.3.1 (Incident module) for structure, semantic mapping, and write-gating.

## Token Estimation Rationale

| Component | Tokens |
|-----------|--------|
| Module scaffolding (index.ts, interface implementation) | 3K |
| Tool definitions with Zod schemas (6 tools) | 9K |
| Tool handler implementations | 6K |
| Semantic parameter mapping (states, types) | 2K |
| Write-gating logic and config integration | 2K |
| Error handling and response formatting | 1K |
| Debugging and iteration buffer | 2K |
| **Total** | **25K** |
