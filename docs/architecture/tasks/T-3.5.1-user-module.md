# Task T-3.5.1: User Module

## Meta
| Field | Value |
|-------|-------|
| Task ID | T-3.5.1 |
| Milestone | M3 - Extended Modules |
| Module | User Management |
| Priority | Medium |
| Effort | 3h |
| Estimated Tokens | 18K |
| Recommended Model | Haiku |
| Dependencies | T-1.5.2 (module registry), T-1.4.1 (error normalizer) |
| Parallel Group | PG-5 |
| AC Mapping | -- |

## Objective

Implement the User module providing read-only access to ServiceNow's user and group tables. This module is intentionally read-only by design -- user management via MCP is restricted to lookups for safety. No write operations are supported, and there is no `allow_write` configuration flag. The module provides tools for searching users, viewing user details, querying group memberships, and listing group members.

## Acceptance Criteria

- `search_users` tool accepts `query` (optional search term across name/email/user_name), `department` (optional), `active` (optional, default true), `limit` (optional, default 10), `offset` (optional).
- `get_user` tool accepts `sys_id` or `user_name` or `email` (at least one required), returns full user record.
- `get_user_groups` tool accepts `user_sys_id` (required), returns all groups the user belongs to by querying the `sys_user_grmember` table.
- `get_group_members` tool accepts `group_sys_id` or `group_name` (at least one required), returns all members of the specified group.
- All four tools are always registered when `user.enabled=true` (no write-gating needed).
- All tool input schemas use Zod with `.describe()` annotations for AI discoverability.
- Module implements the `ServiceNowModule` interface.
- All errors returned as MCP-compliant `CallToolResult` with `isError: true`.

## Technical Notes

- **Module structure**: Create `src/modules/user/index.ts` (module definition + registration) and `src/modules/user/tools.ts` (tool handlers).
- **Tables**: `sys_user` (users), `sys_user_group` (groups), `sys_user_grmember` (group membership -- junction table linking users to groups).
- **No write operations**: This module is explicitly read-only by design (FR-021). The `register` method does not check any `allow_write` flag -- all tools are always registered when the module is enabled. Document this design decision clearly in code comments.
- **User search**: Search across multiple fields using OR conditions: `user_nameLIKE{term}^ORnameLIKE{term}^ORemailLIKE{term}`. Filter by `active=true` by default.
- **Get user by identifier**: Support lookup by `sys_id` (direct GET), `user_name` (query), or `email` (query). If `sys_id` is provided, use direct record GET. Otherwise, use query with the appropriate field.
- **Group membership query**: Query `sys_user_grmember` with `user={user_sys_id}`, then include group details by using `sysparm_display_value=true` or by dot-walking `group.name`, `group.description`.
- **Group members query**: If `group_sys_id` is provided, query `sys_user_grmember` with `group={group_sys_id}`. If `group_name` is provided, first resolve the group name to `sys_id` via `sys_user_group` table, then query membership.
- **Default fields for user search**: Return `sys_id`, `user_name`, `name`, `email`, `department`, `title`, `active`, `manager`.
- **Default fields for group**: Return `sys_id`, `name`, `description`, `email`, `type`, `active`.
- **Haiku-suitable**: This module is straightforward (read-only, no write-gating, simple query patterns) and follows established patterns from prior modules, making it suitable for a smaller/faster model.

## Token Estimation Rationale

| Component | Tokens |
|-----------|--------|
| Module scaffolding (index.ts, interface implementation) | 2K |
| Tool definitions with Zod schemas (4 tools) | 6K |
| Tool handler implementations | 5K |
| Group membership query logic | 2K |
| Error handling and response formatting | 1K |
| Debugging and iteration buffer | 2K |
| **Total** | **18K** |
