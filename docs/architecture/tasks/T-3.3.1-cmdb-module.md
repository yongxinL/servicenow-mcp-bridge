# Task T-3.3.1: CMDB Module

## Meta
| Field | Value |
|-------|-------|
| Task ID | T-3.3.1 |
| Milestone | M3 - Extended Modules |
| Module | CMDB (Configuration Management Database) |
| Priority | Medium |
| Effort | 4h |
| Estimated Tokens | 25K |
| Recommended Model | Sonnet |
| Dependencies | T-1.5.2 (module registry), T-1.4.1 (error normalizer) |
| Parallel Group | PG-5 |
| AC Mapping | -- |

## Objective

Implement the CMDB module providing semantic access to ServiceNow's Configuration Management Database. This module is high value for infrastructure teams, enabling AI assistants to query configuration items (CIs) and their relationships. Read operations (`query_cis`, `get_ci`, `get_ci_relationships`) are always registered. Write operations (`create_ci`, `update_ci`) are conditionally registered based on the `cmdb.allow_write` configuration flag.

## Acceptance Criteria

- `query_cis` tool accepts `ci_class` (optional, defaults to `cmdb_ci`), `query` (optional sysparm_query), `name` (optional, filter by CI name), `category` (optional), `operational_status` (optional), `fields` (optional), `limit` (optional, default 10), `offset` (optional).
- `get_ci` tool accepts `sys_id` (required) and `ci_class` (optional, defaults to `cmdb_ci`), returns full CI record.
- `get_ci_relationships` tool accepts `sys_id` (required), `relationship_type` (optional), `direction` (optional, "parent"/"child"/"both", default "both"), returns related CIs from the `cmdb_rel_ci` table with relationship metadata.
- `create_ci` tool accepts `ci_class` (required), `name` (required), `fields` (required key-value object with additional CI attributes).
- `update_ci` tool accepts `sys_id` (required), `ci_class` (optional, defaults to `cmdb_ci`), `fields` (required key-value object).
- Given `cmdb.allow_write=false`, only `query_cis`, `get_ci`, and `get_ci_relationships` are registered.
- Given `cmdb.allow_write=true`, all five tools are registered.
- All tool input schemas use Zod with `.describe()` annotations for AI discoverability.
- Module implements the `ServiceNowModule` interface.
- All errors returned as MCP-compliant `CallToolResult` with `isError: true`.

## Technical Notes

- **Module structure**: Create `src/modules/cmdb/index.ts` (module definition + registration) and `src/modules/cmdb/tools.ts` (tool handlers).
- **Tables**: Primary table is `cmdb_ci`, but CMDB uses an inheritance hierarchy (e.g., `cmdb_ci_server`, `cmdb_ci_app_server`, `cmdb_ci_database`). The `ci_class` parameter allows querying specific subclass tables.
- **Relationship table**: `cmdb_rel_ci` stores relationships between CIs. Each record has `parent`, `child`, and `type` fields. Query this table using the CI's `sys_id` as either `parent` or `child` depending on the `direction` parameter.
- **Relationship query construction**:
  - `direction: "parent"` -> `sysparm_query=child={sys_id}` (find CIs that are parents of this CI)
  - `direction: "child"` -> `sysparm_query=parent={sys_id}` (find CIs that are children of this CI)
  - `direction: "both"` -> `sysparm_query=parent={sys_id}^ORchild={sys_id}` (find all related CIs)
- **Operational status mapping**: Map semantic values to ServiceNow numbers (1=Operational, 2=Non-Operational, 3=Repair in Progress, 4=DR Standby, etc.).
- **Default fields for query**: Return `sys_id`, `name`, `sys_class_name`, `category`, `operational_status`, `ip_address`, `os`, `environment`, `sys_updated_on`.
- **Display values**: Use `sysparm_display_value=true` for human-readable field values.
- **Follow patterns from**: T-2.1.1 (Generic module) for the flexible query approach, T-2.3.1 (Incident module) for semantic mapping.

## Token Estimation Rationale

| Component | Tokens |
|-----------|--------|
| Module scaffolding (index.ts, interface implementation) | 3K |
| Tool definitions with Zod schemas (5 tools) | 8K |
| Tool handler implementations | 5K |
| Relationship query logic (cmdb_rel_ci) | 4K |
| Write-gating logic and config integration | 2K |
| Error handling and response formatting | 1K |
| Debugging and iteration buffer | 2K |
| **Total** | **25K** |
