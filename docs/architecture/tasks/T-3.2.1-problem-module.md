# Task T-3.2.1: Problem Module

## Meta
| Field | Value |
|-------|-------|
| Task ID | T-3.2.1 |
| Milestone | M3 - Extended Modules |
| Module | Problem Management |
| Priority | Medium |
| Effort | 4h |
| Estimated Tokens | 25K |
| Recommended Model | Sonnet |
| Dependencies | T-1.5.2 (module registry), T-1.4.1 (error normalizer) |
| Parallel Group | PG-5 |
| AC Mapping | -- |

## Objective

Implement the Problem Management module providing semantic access to ServiceNow's `problem` table. This module addresses a gap identified in competitor offerings -- neither existing ServiceNow MCP server supports problem management. Read operations (`list_problems`, `get_problem`) are always registered. Write operations (`create_problem`, `update_problem`, `link_incident_to_problem`) are conditionally registered based on the `problem.allow_write` configuration flag.

## Acceptance Criteria

- `list_problems` tool accepts semantic filter parameters: `state` (optional), `priority` (optional), `assigned_to` (optional), `category` (optional), `query` (optional raw sysparm_query), `limit` (optional, default 10), `offset` (optional), `order_by` (optional).
- `get_problem` tool accepts `sys_id` or `number` (at least one required), returns full problem record.
- `create_problem` tool accepts `short_description` (required), `description` (optional), `category` (optional), `priority` (optional), `assigned_to` (optional), `assignment_group` (optional), `impact` (optional), `urgency` (optional).
- `update_problem` tool accepts `sys_id` (required) and `fields` (required key-value object).
- `link_incident_to_problem` tool accepts `problem_sys_id` (required) and `incident_sys_id` (required), updates the incident's `problem_id` field to link it to the problem record.
- Given `problem.allow_write=false`, only `list_problems` and `get_problem` are registered.
- Given `problem.allow_write=true`, all five tools are registered.
- All tool input schemas use Zod with `.describe()` annotations for AI discoverability.
- Module implements the `ServiceNowModule` interface.
- All errors returned as MCP-compliant `CallToolResult` with `isError: true`.

## Technical Notes

- **Module structure**: Create `src/modules/problem/index.ts` (module definition + registration) and `src/modules/problem/tools.ts` (tool handlers).
- **Table**: `problem` -- ServiceNow's problem table.
- **Semantic parameter mapping**: Problem states in ServiceNow use numeric values similar to incidents but with problem-specific states (e.g., 1=New, 2=Assessed, 3=Root Cause Analysis, 4=Fix in Progress, 5=Resolved, 6=Closed).
- **Link incident to problem**: This operation updates the `problem_id` field on the `incident` table record (not the problem table). Use the ServiceNow client to PATCH the incident record. This is a cross-table operation -- the tool description should clearly explain this relationship for AI discoverability.
- **Default fields for list**: Return `sys_id`, `number`, `short_description`, `state`, `priority`, `assigned_to`, `assignment_group`, `category`, `related_incidents` (count), `sys_created_on`, `sys_updated_on`.
- **Display values**: Use `sysparm_display_value=true` for human-readable field values.
- **Competitive advantage**: This module fills a gap -- neither competitor (servicenow-mcp-server, echelon-ai-labs) offers problem management tools.
- **Follow patterns from**: T-2.3.1 (Incident module) for structure, semantic mapping, and write-gating.

## Token Estimation Rationale

| Component | Tokens |
|-----------|--------|
| Module scaffolding (index.ts, interface implementation) | 3K |
| Tool definitions with Zod schemas (5 tools) | 8K |
| Tool handler implementations | 6K |
| Incident-to-problem linking logic | 3K |
| Write-gating logic and config integration | 2K |
| Error handling and response formatting | 1K |
| Debugging and iteration buffer | 2K |
| **Total** | **25K** |
